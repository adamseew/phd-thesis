
%%%%%%%%%%%%%
%           %
% Options   %
%           %
\makeatletter % changing font size to 10.5 (90-105 words per line, 41 lines per page)
\renewcommand\normalsize{%
\@setfontsize\normalsize{10.5}{12.5}}
\renewcommand\small{%
\@setfontsize\small{9.5}{11.5}}
\renewcommand\footnotesize{%
\@setfontsize\footnotesize{8.5}{10.5}}
\renewcommand\scriptsize{%
\@setfontsize\scriptsize{7.5}{9.5}}
\makeatother

\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=1100,stretch=10,shrink=10]{microtype} % better typography?

\usepackage{lettrine} % drop caps to chapter openings
\renewcommand{\LettrineFontHook}{\fontfamily{phv}}

\usepackage{graphicx}
\usepackage{amsfonts, amsmath, amssymb}
\usepackage[T1]{fontenc}
\usepackage[math]{iwona}
\usepackage{ebgaramond}

\usepackage[sort=standard]{glossaries}
\usepackage[xindy,toc=false,nogroupskip,nonumberlist]{glossaries-extra}
\usepackage{imakeidx} 

\usepackage[totoc]{idxlayout}

\DeclareFontFamily{U}{futm}{} % trick for a sans serif mathbb
\DeclareFontShape{U}{futm}{m}{n}{
  <-> s * [.92] fourier-bb
  }{}
\DeclareSymbolFont{Ufutm}{U}{futm}{m}{n}
\DeclareSymbolFontAlphabet{\mathbb}{Ufutm}

\usepackage{helvet} % sans serif

\usepackage{xcolor} % colors
\definecolor{foo}{RGB}{0,51,102}

\newcommand{\otherfont}{\footnotesize\fontfamily{phv}\selectfont}

\newcommand*{\formatpagenum}[1]{\textcolor{foo}{\otherfont#1}}
\newcommand*{\findex}[1]{\index{{#1}|formatpagenum}}
\newcommand*{\sref}[1]{\textcolor{foo}{\otherfont\ref{#1}}}
\newcommand*{\srefsmaller}[1]{\textcolor{foo}{\scriptsize\fontfamily{phv}\selectfont\ref{#1}}}
\newcommand*{\fref}[2]{\textcolor{foo}{\otherfont#2~\ref{#1}}}
\newcommand*{\frefeq}[1]{\textcolor{foo}{\otherfont Equation~(\ref{#1})}}
\newcommand*{\frefeqM}[2]{\textcolor{foo}{\otherfont Equations~(\ref{#1}--\ref{#2})}}
\newcommand*{\frefeqT}[2]{\textcolor{foo}{\otherfont Equation~(\ref{#1})~and~(\ref{#2})}}

\indexsetup{othercode=\small}

\renewcommand{\glsnamefont}[1]{\textbf{#1}}

\newglossary*{notation}{Notation}
\newglossary*{acronym}{Abbreviations}

\renewcommand{\glossarypreamble}{%
 \glsfindwidesttoplevelname[\currentglossary]%
}

\newcommand{\hsp}{\kern 1pt} % for nested quotation marks

% Paragraph formatting
\renewcommand{\baselinestretch}{1.125} % paragraphs spreads the lines further
\setlength{\parskip}{0pt} % disable variable parskip
\setlength{\parindent}{1em}

\frenchspacing % no extra space after sentences

\widowpenalty=10000 % minus widows/orphans
\clubpenalty=10000

% page size
\usepackage[
    paper=b5paper, %  176x250mm or 6.93x9.84in or 7x10in approx
    top=1in,
    bottom=.875in,
    outer=.75in,
    inner=1in % margins source: http://www.bestbookprinting.com/app/webroot/blog/?p=1459
]{geometry}

% reduce overfull \hbox{} warnings
\sloppy

% chapter headings
\usepackage[explicit]{titlesec}

\titleformat{\chapter}[display]
  {\fontfamily{phv}\selectfont\LARGE\bfseries\color{foo}}{\chaptertitlename\ \thechapter}
  {10pt}{\fontfamily{phv}\selectfont\huge#1}
\titlespacing*{\chapter}
  {0pt}{80pt}{40pt}  % controls vertical margins on title
\titleformat{\section}
  {\fontfamily{phv}\selectfont\large\bfseries\color{foo}}
  {\thesection}{1em}{#1}
\titleformat{\subsection}
  {\fontfamily{phv}\selectfont\normalsize\bfseries\color{foo}}
  {\thesubsection}{1em}{#1}
\titleformat{\subsubsection}
  {\fontfamily{phv}\selectfont\small\bfseries\color{foo}}
  {\thesubsubsection}{1em}{#1}



% contents page
\usepackage[titles]{tocloft}
\renewcommand{\cftchapfont}{\small\fontfamily{phv}\selectfont}
\renewcommand{\cftsecfont}{\otherfont}
\renewcommand{\cftfigfont}{\otherfont}
\renewcommand{\cftsubsecfont}{\otherfont}
\renewcommand{\cftchappagefont}{\color{foo}\otherfont}
\renewcommand{\cftsecpagefont}{\color{foo}\otherfont}
\renewcommand{\cftsubsecpagefont}{\color{foo}\otherfont}
\renewcommand{\cftfigpagefont}{\color{foo}\otherfont}

% page number style
\usepackage{etoolbox}
\makeatletter
   \patchcmd{\ps@myheadings}{\hfil\thepage}{\otherfont\nouppercase\oldthepage\thepage}{}{}
\makeatother

% headers/footers
\usepackage{fancyhdr}
\setlength{\headheight}{15pt}
\fancyhf{}
\renewcommand{\headrulewidth}{.4pt}
\renewcommand{\headrule}{\hbox to\headwidth{%
  \color{foo}\leaders\hrule height \headrulewidth\hfill}}
\fancyhead[LE]{\color{foo}\otherfont\thepage}
\fancyhead[RO]{\color{foo}\otherfont\thepage}
\fancyhead[LO]{\color{foo}\otherfont\nouppercase{\rightmark}} 
\fancyhead[RE]{\color{foo}\otherfont\nouppercase{\leftmark}}

\fancypagestyle{plain}{%
  \fancyhf{}%
  \fancyfoot[C]{\otherfont\color{foo}\thepage}%
  \renewcommand{\headrulewidth}{0pt} % line at the header
  \renewcommand{\footrulewidth}{0pt} % line at the footer (both not visible)
}

% blank pages with disabled the current page style
\makeatletter
\def\cleardoublepage{\clearpage\if@twoside \ifodd\c@page\else
   \hbox{}\thispagestyle{empty}\newpage\if@twocolumn\hbox{}\newpage\fi\fi\fi}
\makeatother

% bibliostyle
\PassOptionsToPackage{
  natbib=true,
  style=authoryear-comp,
  hyperref=true,
  backend=biber,
  maxbibnames=200,
  giveninits=true,
  uniquename=init,
  maxcitenames=2,
  parentracker=true,
  url=false,
  doi=false,
  isbn=false,
  eprint=false,
  backref=true,
}{biblatex}
\usepackage{biblatex}
\renewcommand*{\bibfont}{\otherfont}
\usepackage[hidelinks]{hyperref}
\hypersetup{allcolors=foo}
\renewcommand*{\citesetup}{%
  \color{foo}
  \otherfont
  \biburlsetup
  \frenchspacing
}

\DeclareNameAlias{sortname}{family-given} % counts in biblio

\defbibenvironment{bibliography}
  {\begin{enumerate}}
  {\end{enumerate}}
  {\item}

\usepackage{multirow} % tables
\usepackage{tabularx}

\renewcommand\tabularxcolumn[1]{m{#1}}% for vertical centering text in X column

\usepackage{graphicx} % images
\graphicspath{ {./pictures/}{./figures/} } 
\usepackage{caption}
\usepackage{subcaption} % for subfigures
\DeclareCaptionFont{captionff}{\otherfont}
\captionsetup[figure]{labelsep=period,font=captionff}
\captionsetup[table]{labelsep=period,font=captionff}
\captionsetup[sub]{font=captionff}

\renewcommand{\thefigure}{\textcolor{foo}{\fontfamily{phv}\selectfont\thechapter.\arabic{figure}}}
\renewcommand{\figurename}{\textcolor{foo}{\fontfamily{phv}\selectfont Figure}}
\renewcommand{\thetable}{\textcolor{foo}{\fontfamily{phv}\selectfont\arabic{chapter}.\arabic{table}}}
\renewcommand{\tablename}{\textcolor{foo}{\fontfamily{phv}\selectfont Table}}

\renewcommand{\theequation}{\textcolor{foo}{\otherfont\arabic{chapter}.\arabic{equation}}}

\makeatletter % equation parenthesis
\def\tagform@#1{{\color{foo}\maketag@@@{\otherfont(\ignorespaces#1\unskip\@@italiccorr)}}}
\makeatother

\usepackage{tikz}
\usetikzlibrary{shapes,arrows,positioning,calc,automata,decorations.pathreplacing,backgrounds,spy}
\tikzset{
  block/.style = {draw, fill=white, rectangle, minimum height=3em, minimum width=3em},
  tmp/.style  = {coordinate}, 
  sum/.style= {draw, fill=white, circle, node distance=1cm},
  input/.style = {coordinate},
  output/.style= {coordinate},
  pinstyle/.style = {pin edge={to-,thin,black}}
}

\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

\renewcommand{\listfigurename}{Figures} % changing the title for the list of figures

\usepackage{thmtools}
\usepackage{amsthm,regexpatch}

\renewcommand{\qedsymbol}{$\blacksquare$}

\newtheoremstyle{komaplain}
  {\topsep}   % ABOVESPACE
  {\topsep}   % BELOWSPACE
  {}  % BODYFONT
  {0pt}       % INDENT (empty value is the same as 0pt)
  {\color{foo}\otherfont} % HEADFONT
  {.}         % HEADPUNCT
  {5pt plus 1pt minus 1pt} % HEADSPACE
  {{\bfseries\thmname{#1}\thmnumber{ #2}}\thmnote{: #3}}          % CUSTOM-HEAD-SPEC

\theoremstyle{komaplain}
\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}[thm]{Lemma}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{assm}[thm]{Assumption}
\newtheorem{cor}{Corollary}
\newtheorem{conj}{Conjecture}[section]
\newtheorem{defn}{Definition}[section]
\newtheorem{exmp}{Example}[section]
\newtheorem{pb}{Problem}[section]
\newtheorem{rem}{Remark}
\newtheorem*{st}{Status}
\newtheorem*{obs}{Observation}

\usepackage{tcolorbox}

\makeatletter
\newcommand*{\textlabel}[2]{%
  \edef\@currentlabel{#1}% Set target label
  \phantomsection% Correct hyper reference link
  #1\label{#2}% Print and store label
}
\makeatother % for textlabel

\usepackage[inline]{enumitem}

\newcommand{\stt}[1]{{\small\tt #1}} % \small\tt as tt is too big with the provided proof
\newcommand{\powprof}{\stt{powprofiler}}

\newcommand{\matlab}{\mbox{\textsc{M}\hspace{-.25ex}\textsc{a}\hspace{-.25ex}\textsc{t}\hspace{-.25ex}\textsc{l}\hspace{-.25ex}\textsc{a}\hspace{-.25ex}\textsc{b}\hspace{.3ex}(R) }}

\usepackage{diagbox}

\setlength\bibitemsep{1.5\itemsep} % more space to biblio

\usepackage[toc]{appendix}

\usepackage{listings} % code 
\definecolor{dgreen}{RGB}{34,139,34}
\definecolor{dlilas}{RGB}{75,0,130}
\definecolor{dred}{RGB}{139,69,19}



\renewcommand{\lstlistingname}{\color{foo}\fontfamily{phv}\selectfont Listing}
\captionsetup[lstlisting]{labelsep=period,font=captionff}
\AtBeginDocument{%
\lstset{language=Matlab,%
  %basicstyle=\color{red},
  breaklines=true,%
  morekeywords={matlab2tikz},
  keywordstyle=\color{foo},%
  morekeywords=[2]{1}, keywordstyle=[2]{\color{foo}},
  identifierstyle=\color{black},%
  stringstyle=\color{dlilas},
  commentstyle=\color{dgreen},%
  showstringspaces=false,%without this there will be a symbol in the  places where there is a space
  numbers=left,%
  numberstyle={\fontfamily{phv}\selectfont\scriptsize\color{gray}},%  size of the numbers
  numbersep=1ex, % this defines how far the numbers are from the text
  emph=[1]{for,end,break},
  emphstyle=[1]\color{foo}, %some words to emphasise
  emph=[2]{ones}, emphstyle=[2]{\color{foo}},
  basicstyle=\footnotesize\ttfamily,breaklines=true,
  numberblanklines=false,
}}

\usepackage{textpos} % for textblock in the title

\usepackage{amsmath} % for math symbols (for instance, the norm)
\newcommand\norm[1]{\left\lVert#1\right\rVert}

% for landscape figures
\usepackage{wrapfig}
\usepackage{lscape}


\usepackage[counterclockwise, figuresright]{rotating}

\usepackage{pifont}
\newcommand{\cmark}{\ding{51}} 
\newcommand{\xmark}{\ding{55}} % for checkmarks

\usepackage{cleveref} % for refs to already existing footnote
\makeatletter
\newcommand\footnoteref[1]{\protected@xdef\@thefnmark{\ref{#1}}\@footnotemark}
\makeatother

\usepackage{pdflscape} % from Ulrike Fisher to rotate a sideways... env (https://tex.stackexchange.com/a/472608)
\usepackage{eso-pic,zref-user}
\newcounter{cntsideways}
\makeatletter
\AddToShipoutPictureBG{%
 \ifnum\zref@extractdefault{rotate\number\value{page}}{page}{0}=0  
  \PLS@RemoveRotate
 \else 
  \PLS@AddRotate{90}%
 \fi}

\newcommand\rotatesidewayslabel{\stepcounter{cntsideways}%
 \zlabel{tmp\thecntsideways}\zlabel{rotate\zref@extractdefault{tmp\thecntsideways}{page}{0}}}

\usepackage[noend,linesnumbered,vlined]{algorithm2e} % for pseudocode
\SetAlgoCaptionSeparator{.}
\SetAlgoLined
\renewcommand\AlCapFnt{\normalfont\otherfont\color{foo}}
\SetNlSty{}{\color{gray}}{\color{black}}
\SetAlgoNlRelativeSize{-1}
\usepackage{etoolbox}
\AtBeginEnvironment{algorithm}{\let\textnormal\otherfont}
\renewcommand{\thealgocf}{\arabic{chapter}.\arabic{algocf}}
\newcommand{\kwsty}[1]{\textcolor{foo}{#1}}
\SetKwSty{kwsty}

\newcommand\subsubsubsection{\@startsection{paragraph}{4}{\z@}{-2.5ex\@plus -1ex \@minus -.25ex}{1.25ex \@plus .25ex}{\normalsize\otherfont\color{foo}\bfseries}} % for subsubsubsection

\makeatletter % inspirational quotes from https://tex.stackexchange.com/questions/53377
\newenvironment{chapquote}[2][2em]
  {\setlength{\@tempdima}{#1}%
   \def\chapquote@author{#2}%
   \parshape 1 \@tempdima \dimexpr\textwidth-2\@tempdima\relax%
   \itshape}
  {\par\normalfont\hfill---\ \chapquote@author\hspace*{\@tempdima}\par\bigskip}
\makeatother

\usepackage{letltxmacro} % for tt in index (here is findex). From: https://tex.stackexchange.com/questions/409780
% https://tex.stackexchange.com/q/88001/5764
\LetLtxMacro\oldttfamily\ttfamily
\DeclareRobustCommand{\ttfamily}{\oldttfamily\csname ttsize\endcsname}
\newcommand{\setttsize}[1]{\def\ttsize{#1}}%

\usepackage{changepage}

\renewcommand*{\thefootnote}{{\fontfamily{phv}\selectfont\color{foo}\arabic{footnote}}} % footnote number stule

